<script type="text/html" data-template-name="metadata">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Node Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-chatbotName"><i class="icon-tag"></i>Chatbot Name</label>
        <input type="text" id="node-input-chatbotName" placeholder="Name">
    </div>


    <div class="form-row">
        <label for="node-input-instance"><i class="icon-tag"></i>Instance</label>
        <input type="text" id="node-input-instance"><span data-i18n="[placeholder]metadata.wa"></span>
    </div>
    <div class="form-row" style="margin-bottom:12px">
        <button type="button" style="float:right; margin-right:8%; margin-bottom:12px" class="ui-button ui-corner-all ui-widget" name="Instance">Generate Instance</button>
    </div>

    <div class="form-row">
        <label for="node-input-wa">Watson</label>
        <input type="text" id="node-input-wa"></input>
    </div>
    <div class="form-row" style="margin-bottom:12px">
        <button type="button" style="float:right; margin-right:8%; margin-bottom:12px" class="ui-button ui-corner-all ui-widget" name="Watson_Key">Generate Key</button>
    </div>
    <div class="form-row">
        <label for="node-input-ta"><i class="icon-tag"></i>Tone Analyser</label>
        <input type="text" id="node-input-ta" placeholder="API-key">

    </div>
    <div class="form-row" style="margin-bottom:12px">
        <button type="button" style="float:right; margin-right:8%; margin-bottom:12px" class=" ui-button ui-corner-all ui-widget" name="TA_Key">Generate Key</button>
    </div>
    <div class="form-row">
        <label for="node-input-discovery"><i class="icon-tag"></i>Discovery </label>
        <input type="text" id="node-input-discovery" placeholder="API-key">
    </div>
    <div class="form-row">
        <button type="button" style="float:right; margin-right:8%; margin-bottom:12px" class="ui-button ui-corner-all ui-widget" name="Discovery_Key">Generate Key</button>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('metadata', {
        category: 'Watson Designer',
        color: "#a6bbcf",
        defaults: {
            name: {
                value: ""
            },
            payload: {
                value: ""
            },
            wa: {
                value: "NYLBfhff5TKngBCwOxjfRp7dIipvFPm_v1yo_XlR_K7W",
                required: true
            },
            instance: {
                value: "https://api.eu-gb.assistant.watson.cloud.ibm.com/instances/a20b257b-83f7-44a4-8093-2553e67aa381",
                required: true

            },
            ta: {
                value: ""
            },
            discovery: {
                value: ""
            },
            chatbotName: {
                value: "Default Name",
                required: true
            },
            payloadtype: {
                value: "json"
            }

        },
        icon: "inject.svg",
        inputs: 0,
        outputs: 1,
        outputLabels: function(index) {
            var lab = this.payloadType;
            if (lab === "json") {
                try {
                    lab = typeof JSON.parse(this.payload);
                    if (lab === "object") {
                        if (Array.isArray(JSON.parse(this.payload))) {
                            lab = "Array";
                        }
                    }
                } catch (e) {
                    return this._("inject.label.invalid");
                }
            }
            var name = "inject.label." + lab;
            var label = this._(name);
            if (name !== label) {
                return label;
            }
            return lab;
        },
        label: function() {
            return "metadata";
        },
        labelStyle: function() {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function() {

            try {
                this.shared_data = this.context().flow.get("shared_data");
            }catch (e) {
                this.shared_data = {
                    data: {
                        intents: [],
                        entities: []
                    }
                }

                this.context().flow.set("shared_data", this.shared_data);
            }

            $("#node-input-wa").text(this.wa);
            $("#node-input-instance").val(this.instance);
            $("#node-input-chatbotName").val(this.chatbotName);




        },
        button: {
            enabled: function() {
                return !this.changed
            },
            onclick: function() {
                if (this.changed) {
                    return RED.notify(RED._("notification.warning", {
                        message: RED._("notification.warnings.undeployedChanges")
                    }), "warning");
                }
                var payload = this.payload;
                var label = this._def.label.call(this);
                if (label.length > 30) {
                    label = label.substring(0, 50) + "...";
                }
                label = label.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                var node = this;
                $.ajax({
                    url: "metadata/" + this.id,
                    type: "POST",
                    success: function(resp) {
                        RED.notify(node._("data Key passed", {
                            label: label
                        }), {
                            type: "success",
                            id: "inject"
                        });
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify(node._("common.notification.error", {
                                message: node._("common.notification.errors.not-deployed")
                            }), "error");
                        } else if (jqXHR.status == 500) {
                            RED.notify(node._("common.notification.error", {
                                message: node._("inject.errors.failed")
                            }), "error");
                        } else if (jqXHR.status == 0) {
                            RED.notify(node._("common.notification.error", {
                                message: node._("common.notification.errors.no-response")
                            }), "error");
                        } else {
                            RED.notify(node._("common.notification.error", {
                                message: node._("common.notification.errors.unexpected", {
                                    status: jqXHR.status,
                                    message: textStatus
                                })
                            }), "error");
                        }
                    }
                });
            }
        }
    });
</script>